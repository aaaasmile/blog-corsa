{{define "base"}}
<html>

<head>
  <link href="./static/codemirror/LtxTypstEdit.css?{{.Buildnr}}" rel="stylesheet">
  <link href="./static/codemirror/codemirror.css?{{.Buildnr}}" rel="stylesheet">
  <script src="./static/codemirror/codemirror.js?{{.Buildnr}}"></script>
  <script src="./static/codemirror/javascript.js?{{.Buildnr}}"></script>
  <script src="./static/codemirror/markdown.js?{{.Buildnr}}"></script>
</head>

<body>
  <div id="controlAddIn"></div>
  <div id="save"></div>
</body>
<script>
  let g_TypsEditor = null;
  let g_JsonEditor = null;
  let g_TypstText = '';
  let g_JsonText = '';

  function initializeTextScroll() {
    //console.log('[addin] initializeTextScroll ');
    const controlAddIn = document.getElementById('controlAddIn');

    const fildSet = document.createElement('fieldset');
    fildSet.setAttribute("class", "edit");

    const textSourceElmt = document.createElement('textarea');
    textSourceElmt.setAttribute("id", "mySrcSetter");
    fildSet.appendChild(textSourceElmt);

    const dataJsonElmt = document.createElement('textarea');
    dataJsonElmt.setAttribute("id", "myDataJsonSetter");
    fildSet.appendChild(dataJsonElmt);

    controlAddIn.appendChild(fildSet);
  }

  function SetTextSource(txt) {
    g_TypstText = txt;
    const mySrcSetter = document.getElementById('mySrcSetter');
    mySrcSetter.value = txt || '';
    if (!g_TypsEditor) {
      g_TypsEditor = CodeMirror.fromTextArea(mySrcSetter, {
        lineNumbers: true,
        mode: {
          name: "markdown",
        },
      });
    }

    g_TypsEditor.on('change', (args) => {
      //console.log('[change]', args.doc)
      g_TypstText = '';
      if (args.doc.children) {
        if (args.doc.children[0]) {
          const child0 = args.doc.children[0]
          if (child0.lines) {
            //console.log('lines', child0.lines)
            const ll = child0.lines.map(a => a.text);
            g_TypstText = ll.join("\n")
          }
        }
      }
      //console.log('[content]', g_TypstText)
    })
  }

  function SetJsonSource(txt) {
    g_JsonText = txt;
    const myJsonSetter = document.getElementById('myDataJsonSetter');
    myJsonSetter.value = txt || '';
    if (!g_JsonEditor) {
      g_JsonEditor = CodeMirror.fromTextArea(myJsonSetter, {
        lineNumbers: true,
        mode: {
          name: "javascript",
          json: true,
          statementIndent: 2,
        },
      });
    }

    g_JsonEditor.on('change', (args) => {
      //console.log('[change]', args.doc)
      g_JsonText = '';
      if (args.doc.children) {
        if (args.doc.children[0]) {
          const child0 = args.doc.children[0]
          if (child0.lines) {
            //console.log('lines', child0.lines)
            const ll = child0.lines.map(a => a.text);
            g_JsonText = ll.join("\n")
          }
        }
      }
      //console.log('[content]', g_TypstText)
    })
  }

  function CreateSaveButton() {
    const divSave = document.getElementById('save');
    const btSave = document.createElement('button');
    btSave.innerText = "Read"
    divSave.appendChild(btSave);
    btSave.addEventListener('click', function () {
      console.log('[src] ', g_TypstText)
      console.log('[json] ', g_JsonText)
    });
  }
  initializeTextScroll();
  SetTextSource('Hello World!')
  SetJsonSource('{"data": "hello"}')
  CreateSaveButton();
</script>

</html>
{{end}}